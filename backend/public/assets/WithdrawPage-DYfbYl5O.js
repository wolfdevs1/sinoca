import{r as s,A as M,S as W,j as e,L as R,F as T,x as _,y as z,z as P,B as V}from"./index-Ddd2O0cv.js";import{N as b}from"./react-number-format.es-DxmPEpdW.js";import{y as r,L as q}from"./index-BakaLNF9.js";function B(){const{user:n,newUserAccount:g}=s.useContext(M),o=s.useContext(W),[d,j]=s.useState(""),[i,u]=s.useState(""),[l,h]=s.useState(!1),[c,f]=s.useState(""),[m,y]=s.useState(!1),[x,$]=s.useState(new Set),[v,C]=s.useState([]),p=s.useMemo(()=>[...n.accounts].reverse(),[n.accounts]);s.useEffect(()=>{p.length>0&&!i&&u(p[0].name)},[p,i]),s.useEffect(()=>{(async()=>{try{const t=await P(n.name);C(t.data.withdraws)}catch(t){console.error("Error al cargar retiros del usuario:",t)}})()},[n.name]);const S=async a=>{var w,N;a.preventDefault();const t=parseFloat(d);if(isNaN(t)||t<=0){r.error("El importe debe ser mayor a 0.");return}h(!0);try{await V({name:n.name,amount:d,account:i,phone:n.phone}),r.success("Solicitud de retiro realizada correctamente"),j(""),u("")}catch(I){const L=((N=(w=I.response)==null?void 0:w.data)==null?void 0:N.error)||"Error interno del servidor";r.error(L)}finally{h(!1)}},A=s.useCallback(async()=>{h(!0);try{const a=await g(c);r.success(a.message||"Alias agregado correctamente"),u(c),f(""),y(!1)}catch(a){r.error(a.message||"Error al agregar alias")}finally{h(!1)}},[c,g]),E=a=>{a.preventDefault(),o.emit("verify",n.name,n.phone,"new-account",c,t=>{t.ok?r.success(t.msg):r.error(t.msg)})};s.useEffect(()=>{const a=t=>{t.ok?(o.emit("received-verified"),A()):r.error(t.msg)};return o.on("verified",a),()=>{o.off("verified",a)}},[o,A]);const k=()=>{y(!m),m||f("")},F=async a=>{r.info("Funcionalidad de cancelación de retiros aún no implementada")};return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:S,children:[e.jsxs("div",{className:"form-header",children:[e.jsx(R,{to:"/",className:"circle-back-button",title:"Volver al inicio",children:e.jsx(T,{})}),e.jsx("h1",{className:"page-title",children:"RETIRO"})]}),e.jsx(b,{value:d,onValueChange:a=>j(a.value),thousandSeparator:".",decimalSeparator:",",allowNegative:!1,placeholder:"Importe a retirar",className:"input",prefix:"$",allowLeadingZeros:!1,isAllowed:a=>{const{floatValue:t}=a;return t===void 0||t>0},required:!0}),e.jsxs("div",{className:"account-selector",children:[e.jsx("div",{className:"select-wrapper",children:e.jsxs("select",{name:"account",className:"input account-select",value:i,onChange:a=>u(a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar cuenta"}),p.map((a,t)=>e.jsx("option",{value:a.name,children:a.name},t))]})}),e.jsx("button",{type:"button",className:"add-account-btn",onClick:k,title:"Agregar nuevo alias",children:m?e.jsx(_,{}):e.jsx(z,{})})]}),m&&e.jsxs("div",{className:"add-account-section",children:[e.jsx("input",{type:"text",placeholder:"Ingrese el nuevo alias",className:"input",value:c,onChange:a=>f(a.target.value),required:!0}),e.jsx("button",{type:"button",onClick:E,className:"btn add-btn",disabled:l||!c.trim(),children:l?"Agregando...":"Agregar Alias"})]}),e.jsx("div",{className:"btn-group",children:e.jsx("button",{type:"submit",className:`btn ${l?"gray":""}`,disabled:l||!d||!i,children:l?"Procesando...":"Realizar Retiro"})})]}),e.jsxs("table",{className:"withdraw-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"CUENTA"}),e.jsx("th",{children:"IMPORTE"}),e.jsx("th",{children:"ACCIÓN"})]})}),e.jsx("tbody",{children:v.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",style:{textAlign:"center",padding:"10px"},children:"No tenés retiros realizados aún."})}):v.map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.account}),e.jsx("td",{children:e.jsx(b,{value:a.amount,displayType:"text",thousandSeparator:".",decimalSeparator:",",prefix:"$"})}),e.jsx("td",{children:a.state?e.jsx("span",{style:{opacity:.6},children:"Completado"}):e.jsx("button",{className:"btn-cancelar",onClick:()=>F(a._id),disabled:x.has(a._id),style:{opacity:x.has(a._id)?.6:1,cursor:x.has(a._id)?"not-allowed":"pointer"},children:x.has(a._id)?"Cancelando...":"Cancelar"})})]},t))})]}),e.jsx(q,{})]})}export{B as default};
