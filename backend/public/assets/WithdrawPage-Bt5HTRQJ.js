import{r as s,A as q,S as I,j as e,L as T,F as _,x as z,y as P,z as E,B as V,C as $}from"./index-B9y-itMu.js";import{N as k}from"./react-number-format.es-XfHj5thU.js";import{y as n,L as D}from"./index-Vw4t0Yye.js";function Z(){const{user:c,newUserAccount:v}=s.useContext(q),i=s.useContext(I),[m,w]=s.useState(""),[d,p]=s.useState(""),[u,x]=s.useState(!1),[l,y]=s.useState(""),[f,A]=s.useState(!1),[g,N]=s.useState(new Set),[b,S]=s.useState([]),j=s.useMemo(()=>[...c.accounts].reverse(),[c.accounts]);s.useEffect(()=>{j.length>0&&!d&&p(j[0].name)},[j,d]),s.useEffect(()=>{(async()=>{try{const t=await E(c.name);S(t.data.withdraws)}catch(t){console.error("Error al cargar retiros del usuario:",t)}})()},[c.name]);const M=async a=>{var h,r;a.preventDefault();const t=parseFloat(m);if(isNaN(t)||t<=0){n.error("El importe debe ser mayor a 0.");return}x(!0);try{await V({name:c.name,amount:m,account:d,phone:c.phone}),n.success("Solicitud de retiro realizada correctamente"),w(""),p("")}catch(o){const R=((r=(h=o.response)==null?void 0:h.data)==null?void 0:r.error)||"Error interno del servidor";n.error(R)}finally{x(!1)}},C=s.useCallback(async()=>{x(!0);try{const a=await v(l);n.success(a.message||"Alias agregado correctamente"),p(l),y(""),A(!1)}catch(a){n.error(a.message||"Error al agregar alias")}finally{x(!1)}},[l,v]),W=a=>{a.preventDefault(),i.emit("verify",c.name,c.phone,"new-account",l,t=>{t.ok?n.success(t.msg):n.error(t.msg)})};s.useEffect(()=>{const a=t=>{t.ok?(i.emit("received-verified"),C()):n.error(t.msg)};return i.on("verified",a),()=>{i.off("verified",a)}},[i,C]);const F=()=>{A(!f),f||y("")},L=async a=>{var t,h;if(window.confirm("¿Estás seguro de que querés cancelar este retiro?")){N(r=>new Set(r).add(a));try{const r=await $(a);n.success(r.data.message||"Retiro cancelado correctamente");const o=await E(c.name);S(o.data.withdraws)}catch(r){const o=((h=(t=r.response)==null?void 0:t.data)==null?void 0:h.error)||"Error al cancelar el retiro";n.error(o),console.error("Error en handleCancel:",r)}finally{N(r=>{const o=new Set(r);return o.delete(a),o})}}};return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:M,children:[e.jsxs("div",{className:"form-header",children:[e.jsx(T,{to:"/",className:"circle-back-button",title:"Volver al inicio",children:e.jsx(_,{})}),e.jsx("h1",{className:"page-title",children:"RETIRO"})]}),e.jsx(k,{value:m,onValueChange:a=>w(a.value),thousandSeparator:".",decimalSeparator:",",allowNegative:!1,placeholder:"Importe a retirar",className:"input",prefix:"$",allowLeadingZeros:!1,isAllowed:a=>{const{floatValue:t}=a;return t===void 0||t>0},required:!0}),e.jsxs("div",{className:"account-selector",children:[e.jsx("div",{className:"select-wrapper",children:e.jsxs("select",{name:"account",className:"input account-select",value:d,onChange:a=>p(a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar cuenta"}),j.map((a,t)=>e.jsx("option",{value:a.name,children:a.name},t))]})}),e.jsx("button",{type:"button",className:"add-account-btn",onClick:F,title:"Agregar nuevo alias",children:f?e.jsx(z,{}):e.jsx(P,{})})]}),f&&e.jsxs("div",{className:"add-account-section",children:[e.jsx("input",{type:"text",placeholder:"Ingrese el nuevo alias",className:"input",value:l,onChange:a=>y(a.target.value),required:!0}),e.jsx("button",{type:"button",onClick:W,className:"btn add-btn",disabled:u||!l.trim(),children:u?"Agregando...":"Agregar Alias"})]}),e.jsx("div",{className:"btn-group",children:e.jsx("button",{type:"submit",className:`btn ${u?"gray":""}`,disabled:u||!m||!d,children:u?"Procesando...":"Realizar Retiro"})})]}),e.jsxs("table",{className:"withdraw-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"CUENTA"}),e.jsx("th",{children:"IMPORTE"}),e.jsx("th",{children:"ACCIÓN"})]})}),e.jsx("tbody",{children:b.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",style:{textAlign:"center",padding:"10px"},children:"No tenés retiros realizados aún."})}):b.map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.account}),e.jsx("td",{children:e.jsx(k,{value:a.amount,displayType:"text",thousandSeparator:".",decimalSeparator:",",prefix:"$"})}),e.jsx("td",{children:a.state?e.jsx("span",{style:{opacity:.6},children:"Completado"}):e.jsx("button",{className:"btn-cancelar",onClick:()=>L(a._id),disabled:g.has(a._id),style:{opacity:g.has(a._id)?.6:1,cursor:g.has(a._id)?"not-allowed":"pointer"},children:g.has(a._id)?"Cancelando...":"Cancelar"})})]},t))})]}),e.jsx(D,{})]})}export{Z as default};
