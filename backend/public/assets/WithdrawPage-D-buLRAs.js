import{r as s,A as q,S as I,y as c,j as e,L as T,F as _,w as z,x as P,a as V,z as E,B as $,C as D}from"./index-7TbXoDE9.js";import{N as k}from"./react-number-format.es-DVzFIbm7.js";function B(){const{user:o,newUserAccount:w}=s.useContext(q),i=s.useContext(I),[m,v]=s.useState(""),[d,x]=s.useState(""),[u,p]=s.useState(!1),[l,y]=s.useState(""),[g,A]=s.useState(!1),[f,N]=s.useState(new Set),[b,C]=s.useState([]),j=s.useMemo(()=>[...o.accounts].reverse(),[o.accounts]);s.useEffect(()=>{j.length>0&&!d&&x(j[0].name)},[j,d]),s.useEffect(()=>{(async()=>{try{const t=await E(o.name);C(t.data.withdraws)}catch(t){console.error("Error al cargar retiros del usuario:",t)}})()},[o.name]);const M=async a=>{var h,r;a.preventDefault();const t=parseFloat(m);if(isNaN(t)||t<=0){c.error("El importe debe ser mayor a 0.");return}p(!0);try{const n=await $({name:o.name,amount:m,account:d,phone:o.phone});c.success(n.data.message||"Retiro realizado correctamente"),v(""),x("")}catch(n){const L=((r=(h=n.response)==null?void 0:h.data)==null?void 0:r.error)||"Error interno del servidor";c.error(L)}finally{p(!1)}},S=s.useCallback(async()=>{p(!0);try{const a=await w(l);c.success(a.message||"Alias agregado correctamente"),x(l),y(""),A(!1)}catch(a){c.error(a.message||"Error al agregar alias")}finally{p(!1)}},[l,w]),R=a=>{a.preventDefault(),i.emit("verify",o.name,o.phone,"new-account",l,t=>{t.ok?c.success(t.msg):c.error(t.msg)})};s.useEffect(()=>{const a=t=>{t.ok?(i.emit("received-verified"),S()):c.error(t.msg)};return i.on("verified",a),()=>{i.off("verified",a)}},[i,S]);const W=()=>{A(!g),g||y("")},F=async a=>{var t,h;if(window.confirm("¿Estás seguro de que querés cancelar este retiro?")){N(r=>new Set(r).add(a));try{const r=await D(a);c.success(r.data.message||"Retiro cancelado correctamente");const n=await E(o.name);C(n.data.withdraws)}catch(r){const n=((h=(t=r.response)==null?void 0:t.data)==null?void 0:h.error)||"Error al cancelar el retiro";c.error(n),console.error("Error en handleCancel:",r)}finally{N(r=>{const n=new Set(r);return n.delete(a),n})}}};return e.jsxs(e.Fragment,{children:[e.jsxs("form",{onSubmit:M,children:[e.jsxs("div",{className:"form-header",children:[e.jsx(T,{to:"/",className:"circle-back-button",title:"Volver al inicio",children:e.jsx(_,{})}),e.jsx("h1",{className:"page-title",children:"RETIRO"})]}),e.jsx(k,{value:m,onValueChange:a=>v(a.value),thousandSeparator:".",decimalSeparator:",",allowNegative:!1,placeholder:"Importe a retirar",className:"input",prefix:"$",allowLeadingZeros:!1,isAllowed:a=>{const{floatValue:t}=a;return t===void 0||t>0},required:!0}),e.jsxs("div",{className:"account-selector",children:[e.jsx("div",{className:"select-wrapper",children:e.jsxs("select",{name:"account",className:"input account-select",value:d,onChange:a=>x(a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Seleccionar cuenta"}),j.map((a,t)=>e.jsx("option",{value:a.name,children:a.name},t))]})}),e.jsx("button",{type:"button",className:"add-account-btn",onClick:W,title:"Agregar nuevo alias",children:g?e.jsx(z,{}):e.jsx(P,{})})]}),g&&e.jsxs("div",{className:"add-account-section",children:[e.jsx("input",{type:"text",placeholder:"Ingrese el nuevo alias",className:"input",value:l,onChange:a=>y(a.target.value),required:!0}),e.jsx("button",{type:"button",onClick:R,className:"btn add-btn",disabled:u||!l.trim(),children:u?"Agregando...":"Agregar Alias"})]}),e.jsx("div",{className:"btn-group",children:e.jsx("button",{type:"submit",className:`btn ${u?"gray":""}`,disabled:u||!m||!d,children:u?"Procesando...":"Realizar Retiro"})})]}),e.jsxs("table",{className:"withdraw-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"CUENTA"}),e.jsx("th",{children:"IMPORTE"}),e.jsx("th",{children:"ACCIÓN"})]})}),e.jsx("tbody",{children:b.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",style:{textAlign:"center",padding:"10px"},children:"No tenés retiros realizados aún."})}):b.map((a,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:a.account}),e.jsx("td",{children:e.jsx(k,{value:a.amount,displayType:"text",thousandSeparator:".",decimalSeparator:",",prefix:"$"})}),e.jsx("td",{children:a.state?e.jsx("span",{style:{opacity:.6},children:"Completado"}):e.jsx("button",{className:"btn-cancelar",onClick:()=>F(a._id),disabled:f.has(a._id),style:{opacity:f.has(a._id)?.6:1,cursor:f.has(a._id)?"not-allowed":"pointer"},children:f.has(a._id)?"Cancelando...":"Cancelar"})})]},t))})]}),e.jsx(V,{})]})}export{B as default};
